<?xml version="1.0" encoding="utf-8" ?>
<ContentPage
    x:Class="Calendar.Views.CalendarPage"
    xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
    xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
    xmlns:viewmodels="clr-namespace:Calendar.ViewModels"
    Title="Agenda Pessoal"
    BackgroundColor="#f8fafc">

    <ContentPage.Resources>
        <ResourceDictionary>
            <!-- Cores modernas -->
            <Color x:Key="PrimaryColor">#6366f1</Color>
            <Color x:Key="SecondaryColor">#8b5cf6</Color>
            <Color x:Key="AccentColor">#10b981</Color>
            <Color x:Key="SurfaceColor">#ffffff</Color>
            <Color x:Key="BackgroundColor">#f8fafc</Color>
            <Color x:Key="TextPrimaryColor">#1f2937</Color>
            <Color x:Key="TextSecondaryColor">#6b7280</Color>
            <Color x:Key="TextMutedColor">#9ca3af</Color>
            <Color x:Key="BorderColor">#e5e7eb</Color>
            <Color x:Key="ErrorColor">#ef4444</Color>
            <Color x:Key="WarningColor">#f59e0b</Color>
            <Color x:Key="SuccessColor">#10b981</Color>

            <!-- Gradientes -->
            <LinearGradientBrush x:Key="PrimaryGradient" EndPoint="1,1" StartPoint="0,0">
                <GradientStop Color="#6366f1" Offset="0" />
                <GradientStop Color="#8b5cf6" Offset="1" />
            </LinearGradientBrush>

            <LinearGradientBrush x:Key="HeaderGradient" EndPoint="1,1" StartPoint="0,0">
                <GradientStop Color="#667eea" Offset="0" />
                <GradientStop Color="#764ba2" Offset="1" />
            </LinearGradientBrush>

            <!-- Estilos dos botões de navegação -->
            <Style x:Key="HeaderButtonStyle" TargetType="Button">
                <Setter Property="BackgroundColor" Value="{StaticResource SurfaceColor}" />
                <Setter Property="TextColor" Value="{StaticResource PrimaryColor}" />
                <Setter Property="FontSize" Value="14" />
                <Setter Property="FontAttributes" Value="Bold" />
                <Setter Property="Padding" Value="20,12" />
                <Setter Property="CornerRadius" Value="25" />
                <Setter Property="Shadow">
                    <Setter.Value>
                        <Shadow Brush="Black" Offset="0,2" Radius="4" Opacity="0.1" />
                    </Setter.Value>
                </Setter>
            </Style>

            <!-- Estilos das abas -->
            <Style x:Key="TabButtonStyle" TargetType="Button">
                <Setter Property="BackgroundColor" Value="Transparent" />
                <Setter Property="TextColor" Value="White" />
                <Setter Property="FontSize" Value="13" />
                <Setter Property="FontAttributes" Value="Bold" />
                <Setter Property="Padding" Value="16,8" />
                <Setter Property="CornerRadius" Value="20" />
                <Setter Property="BorderColor" Value="White" />
                <Setter Property="BorderWidth" Value="1" />
                <Setter Property="Opacity" Value="0.7" />
            </Style>

            <Style x:Key="ActiveTabButtonStyle" BasedOn="{StaticResource TabButtonStyle}" TargetType="Button">
                <Setter Property="BackgroundColor" Value="White" />
                <Setter Property="TextColor" Value="{StaticResource PrimaryColor}" />
                <Setter Property="BorderWidth" Value="0" />
                <Setter Property="Opacity" Value="1" />
                <Setter Property="FontAttributes" Value="Bold" />
            </Style>

            <!-- Estilo dos dias do calendário -->
            <Style x:Key="CalendarDayStyle" TargetType="Frame">
                <Setter Property="BackgroundColor" Value="Transparent" />
                <Setter Property="BorderColor" Value="Transparent" />
                <Setter Property="Padding" Value="0" />
                <Setter Property="HasShadow" Value="False" />
                <Setter Property="CornerRadius" Value="12" />
                <Setter Property="HeightRequest" Value="48" />
                <Setter Property="WidthRequest" Value="48" />
            </Style>

            <!-- Estilo do botão de adicionar evento -->
            <Style x:Key="AddEventButtonStyle" TargetType="Button">
                <Setter Property="BackgroundColor" Value="{StaticResource AccentColor}" />
                <Setter Property="TextColor" Value="White" />
                <Setter Property="FontSize" Value="16" />
                <Setter Property="FontAttributes" Value="Bold" />
                <Setter Property="Padding" Value="0,16" />
                <Setter Property="CornerRadius" Value="25" />
                <Setter Property="Shadow">
                    <Setter.Value>
                        <Shadow Brush="{StaticResource AccentColor}" Offset="0,4" Radius="8" Opacity="0.3" />
                    </Setter.Value>
                </Setter>
            </Style>

            <!-- Converters (assumindo que existem) -->
            <DataTemplate x:Key="EventItemTemplate">
                <Frame Margin="0,4" Padding="16" BackgroundColor="{StaticResource SurfaceColor}" 
                       CornerRadius="12" HasShadow="True">
                    <Frame.Shadow>
                        <Shadow Brush="Black" Offset="0,2" Radius="4" Opacity="0.1" />
                    </Frame.Shadow>
                    
                    <Grid>
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="4" />
                            <ColumnDefinition Width="*" />
                            <ColumnDefinition Width="Auto" />
                        </Grid.ColumnDefinitions>

                        <!-- Indicador de cor -->
                        <BoxView Grid.Column="0" BackgroundColor="{Binding Color}" CornerRadius="2" />

                        <!-- Conteúdo do evento -->
                        <StackLayout Grid.Column="1" Margin="12,0,0,0">
                            <Label Text="{Binding Title}" FontSize="16" FontAttributes="Bold" 
                                   TextColor="{StaticResource TextPrimaryColor}" />
                            <Label Text="{Binding Description}" FontSize="14" 
                                   TextColor="{StaticResource TextSecondaryColor}" 
                                   IsVisible="{Binding Description, Converter={StaticResource StringToBoolConverter}}" />
                            <Label Text="{Binding Category}" FontSize="12" FontAttributes="Bold"
                                   TextColor="{StaticResource PrimaryColor}" />
                        </StackLayout>

                        <!-- Botão de deletar -->
                        <Button Grid.Column="2" BackgroundColor="Transparent" 
                                Text="🗑️" FontSize="18" 
                                TextColor="{StaticResource ErrorColor}"
                                Command="{Binding Source={RelativeSource AncestorType={x:Type viewmodels:CalendarViewModel}}, Path=DeleteEventCommand}"
                                CommandParameter="{Binding .}" />
                    </Grid>
                </Frame>
            </DataTemplate>
        </ResourceDictionary>
    </ContentPage.Resources>

    <!-- Container principal -->
    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto" />
            <RowDefinition Height="*" />
        </Grid.RowDefinitions>

        <!-- Header com gradiente -->
        <Frame Grid.Row="0" Background="{StaticResource HeaderGradient}" 
               HasShadow="True" CornerRadius="0,0,30,30" Padding="0">
            <Frame.Shadow>
                <Shadow Brush="Black" Offset="0,4" Radius="8" Opacity="0.15" />
            </Frame.Shadow>
            
            <StackLayout Padding="24,40,24,24" Spacing="24">
                <!-- Título principal -->
                <Label Text="✨ Agenda Pessoal" FontSize="28" FontAttributes="Bold"
                       HorizontalOptions="Center" TextColor="White" />

                <!-- Navegação por abas -->
                <ScrollView Orientation="Horizontal" HorizontalScrollBarVisibility="Never">
                    <StackLayout Orientation="Horizontal" Spacing="12" HorizontalOptions="Center">
                        <Button Style="{StaticResource TabButtonStyle}" Text="🕐 Horários" />
                        <Button Style="{StaticResource ActiveTabButtonStyle}" Text="📅 Calendário" />
                        <Button Style="{StaticResource TabButtonStyle}" Text="✅ Tarefas" />
                        <Button Style="{StaticResource TabButtonStyle}" Text="📝 Diário" />
                    </StackLayout>
                </ScrollView>
            </StackLayout>
        </Frame>

        <!-- Conteúdo principal -->
        <ScrollView Grid.Row="1" Padding="20,0">
            <StackLayout Spacing="20" Margin="0,20,0,40">
                
                <!-- Header do calendário -->
                <Frame BackgroundColor="{StaticResource SurfaceColor}" CornerRadius="20" 
                       Padding="20,16" HasShadow="True">
                    <Frame.Shadow>
                        <Shadow Brush="Black" Offset="0,2" Radius="8" Opacity="0.1" />
                    </Frame.Shadow>
                    
                    <Grid>
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="Auto" />
                            <ColumnDefinition Width="*" />
                            <ColumnDefinition Width="Auto" />
                        </Grid.ColumnDefinitions>

                        <Button Grid.Column="0" Style="{StaticResource HeaderButtonStyle}" 
                                Text="← Anterior" Command="{Binding PreviousMonthCommand}" />

                        <Label Grid.Column="1" Text="{Binding MonthYearText}" FontSize="20" 
                               FontAttributes="Bold" HorizontalOptions="Center" VerticalOptions="Center"
                               TextColor="{StaticResource TextPrimaryColor}" />

                        <Button Grid.Column="2" Style="{StaticResource HeaderButtonStyle}" 
                                Text="Próximo →" Command="{Binding NextMonthCommand}" />
                    </Grid>
                </Frame>

                <!-- Calendário -->
                <Frame BackgroundColor="{StaticResource SurfaceColor}" CornerRadius="20" 
                       Padding="20" HasShadow="True">
                    <Frame.Shadow>
                        <Shadow Brush="Black" Offset="0,2" Radius="8" Opacity="0.1" />
                    </Frame.Shadow>
                    
                    <StackLayout Spacing="16">
                        <!-- Cabeçalho dos dias da semana -->
                        <Grid>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*" />
                                <ColumnDefinition Width="*" />
                                <ColumnDefinition Width="*" />
                                <ColumnDefinition Width="*" />
                                <ColumnDefinition Width="*" />
                                <ColumnDefinition Width="*" />
                                <ColumnDefinition Width="*" />
                            </Grid.ColumnDefinitions>

                            <Label Grid.Column="0" Text="Dom" FontSize="12" FontAttributes="Bold" 
                                   HorizontalOptions="Center" TextColor="{StaticResource TextMutedColor}" />
                            <Label Grid.Column="1" Text="Seg" FontSize="12" FontAttributes="Bold" 
                                   HorizontalOptions="Center" TextColor="{StaticResource TextMutedColor}" />
                            <Label Grid.Column="2" Text="Ter" FontSize="12" FontAttributes="Bold" 
                                   HorizontalOptions="Center" TextColor="{StaticResource TextMutedColor}" />
                            <Label Grid.Column="3" Text="Qua" FontSize="12" FontAttributes="Bold" 
                                   HorizontalOptions="Center" TextColor="{StaticResource TextMutedColor}" />
                            <Label Grid.Column="4" Text="Qui" FontSize="12" FontAttributes="Bold" 
                                   HorizontalOptions="Center" TextColor="{StaticResource TextMutedColor}" />
                            <Label Grid.Column="5" Text="Sex" FontSize="12" FontAttributes="Bold" 
                                   HorizontalOptions="Center" TextColor="{StaticResource TextMutedColor}" />
                            <Label Grid.Column="6" Text="Sáb" FontSize="12" FontAttributes="Bold" 
                                   HorizontalOptions="Center" TextColor="{StaticResource TextMutedColor}" />
                        </Grid>

                        <!-- Grade do calendário -->
                        <CollectionView ItemsSource="{Binding CalendarDays}" SelectionMode="None">
                            <CollectionView.ItemsLayout>
                                <GridItemsLayout HorizontalItemSpacing="4" VerticalItemSpacing="4" 
                                                 Orientation="Vertical" Span="7" />
                            </CollectionView.ItemsLayout>

                            <CollectionView.ItemTemplate>
                                <DataTemplate>
                                    <Frame Style="{StaticResource CalendarDayStyle}">
                                        <Frame.Triggers>
                                            <DataTrigger Binding="{Binding IsSelected}" TargetType="Frame" Value="True">
                                                <Setter Property="BackgroundColor" Value="{StaticResource PrimaryColor}" />
                                                <Setter Property="Shadow">
                                                    <Setter.Value>
                                                        <Shadow Brush="{StaticResource PrimaryColor}" Offset="0,4" Radius="8" Opacity="0.3" />
                                                    </Setter.Value>
                                                </Setter>
                                            </DataTrigger>
                                            <DataTrigger Binding="{Binding IsToday}" TargetType="Frame" Value="True">
                                                <Setter Property="BorderColor" Value="{StaticResource PrimaryColor}" />
                                                <Setter Property="BorderWidth" Value="2" />
                                            </DataTrigger>
                                        </Frame.Triggers>

                                        <Frame.GestureRecognizers>
                                            <TapGestureRecognizer Command="{Binding Source={RelativeSource AncestorType={x:Type viewmodels:CalendarViewModel}}, Path=DaySelectedCommand}" 
                                                                  CommandParameter="{Binding .}" />
                                        </Frame.GestureRecognizers>

                                        <Grid>
                                            <Label Text="{Binding Day}" FontSize="16" 
                                                   HorizontalOptions="Center" VerticalOptions="Center">
                                                <Label.Triggers>
                                                    <DataTrigger Binding="{Binding IsCurrentMonth}" TargetType="Label" Value="False">
                                                        <Setter Property="TextColor" Value="{StaticResource TextMutedColor}" />
                                                        <Setter Property="Opacity" Value="0.5" />
                                                    </DataTrigger>
                                                    <DataTrigger Binding="{Binding IsSelected}" TargetType="Label" Value="True">
                                                        <Setter Property="TextColor" Value="White" />
                                                        <Setter Property="FontAttributes" Value="Bold" />
                                                    </DataTrigger>
                                                    <DataTrigger Binding="{Binding IsToday}" TargetType="Label" Value="True">
                                                        <Setter Property="FontAttributes" Value="Bold" />
                                                        <Setter Property="TextColor" Value="{StaticResource PrimaryColor}" />
                                                    </DataTrigger>
                                                </Label.Triggers>
                                            </Label>

                                            <!-- Indicador de eventos -->
                                            <Ellipse Margin="0,4,4,0" Fill="{StaticResource AccentColor}" 
                                                     HeightRequest="6" WidthRequest="6"
                                                     HorizontalOptions="End" VerticalOptions="Start" 
                                                     IsVisible="{Binding HasEvents}" />
                                        </Grid>
                                    </Frame>
                                </DataTemplate>
                            </CollectionView.ItemTemplate>
                        </CollectionView>
                    </StackLayout>
                </Frame>

                <!-- Eventos do dia selecionado -->
                <Frame BackgroundColor="{StaticResource SurfaceColor}" CornerRadius="20" 
                       Padding="20" HasShadow="True"
                       IsVisible="{Binding SelectedDateEvents.Count, Converter={StaticResource IntToBoolConverter}}">
                    <Frame.Shadow>
                        <Shadow Brush="Black" Offset="0,2" Radius="8" Opacity="0.1" />
                    </Frame.Shadow>
                    
                    <StackLayout Spacing="16">
                        <Label Text="📅 Eventos do Dia" FontSize="18" FontAttributes="Bold"
                               TextColor="{StaticResource TextPrimaryColor}" />

                        <CollectionView ItemsSource="{Binding SelectedDateEvents}" 
                                        ItemTemplate="{StaticResource EventItemTemplate}" />
                    </StackLayout>
                </Frame>

                <!-- Botão de adicionar evento -->
                <Button Style="{StaticResource AddEventButtonStyle}" 
                        Text="➕ Adicionar Evento" 
                        Command="{Binding AddEventCommand}" />
            </StackLayout>
        </ScrollView>

        <!-- Indicador de carregamento -->
        <ActivityIndicator Grid.Row="1" IsRunning="{Binding IsLoading}" 
                           IsVisible="{Binding IsLoading}" 
                           HorizontalOptions="Center" VerticalOptions="Center"
                           Color="{StaticResource PrimaryColor}" />
    </Grid>
</ContentPage>